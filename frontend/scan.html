<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Scanner</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
        input, button { margin: 10px; padding: 10px; font-size: 16px; }
    </style>
</head>
<body>
    <h2>Scan QR Code</h2>
    <button id="scan-btn">Start Scanning</button>

    <h3>Scanned Data:</h3>
    <p id="qr-data">No data yet</p>

    <!-- âœ… Input Field for Pole Number -->
    <label for="pole-number"><strong>Pole Number:</strong></label>
    <input type="text" id="pole-number" placeholder="Enter pole number">
    <button id="save-btn" disabled>Save Report</button>

    <script>
        let scannedData = null;

        $("#scan-btn").click(function() {
            $.ajax({
                url: "/scan_qr",  // ðŸ”¹ API route for scanning
                type: "GET",
                success: function(response) {
                    if (response.data) {
                        scannedData = response.data;
                        let familyMembersHtml = scannedData.family_members.map(member => {
                            let childInfo = member.is_child ? `<br><strong>Child Age:</strong> ${member.age} <br><strong>Gender:</strong> ${member.gender} <br><strong>Description:</strong> ${member.description}` : "";
                            return `<br><strong>Family Member:</strong> ${member.name} <br><strong>Phone:</strong> ${member.phone} ${childInfo}`;
                        }).join("");
                        
                        $("#qr-data").html(
                            `<strong>Name:</strong> ${scannedData.name} <br>
                             <strong>Phone:</strong> ${scannedData.phone} <br>
                             <strong>Address:</strong> ${scannedData.address} <br>
                             ${familyMembersHtml}`
                        );
                        $("#save-btn").prop("disabled", false);
                    } else {
                        $("#qr-data").text("No QR Code detected.");
                    }
                },
                error: function(xhr) {
                    alert("Error: " + xhr.responseJSON.error);
                }
            });
        });

        $("#save-btn").click(function() {
            let poleNumber = $("#pole-number").val();
            if (!poleNumber) {
                alert("Please enter the pole number.");
                return;
            }

            $.ajax({
                url: "/submit_report",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    "scanned_data": scannedData,
                    "pole_number": poleNumber
                }),
                success: function(response) {
                    alert(response.message);
                    $("#save-btn").prop("disabled", true);
                    $("#pole-number").val("");
                },
                error: function(xhr) {
                    alert("Error: " + xhr.responseJSON.error);
                }
            });
        });
    </script>
</body>
</html>
